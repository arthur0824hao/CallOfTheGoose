# GooseOnCall 音樂機器人開發記錄

## 2025-03-01 開發中遇到的問題與解決

### 播放問題：過度複雜導致失敗
- **問題**：多層檢查、複雜的PCM轉換和進度監控導致播放無法正常進行
- **解決**：回歸最簡單的播放方式，採用「如無必要，勿增實體」原則
- **原理**：使用最基本的 discord.FFmpegPCMAudio 直接播放，不加任何參數
- **教訓**：優化的前提是基本功能可用，過度優化反而導致不穩定

### 爆音問題
- **問題**：某些歌曲音量過大或不穩定，造成爆音
- **解決**：
  1. 使用 FFmpeg 的 volume 過濾器降低音量 (volume=0.65)
  2. 應用 Discord.py 的 PCMVolumeTransformer 再次調整音量 (volume=0.7)
  3. 保持簡單的參數配置，避免過度複雜化

### 其他已解決問題
- **PCM音訊播放問題**: Discord.py 的音頻系統在調用 PCMStreamReader.read() 方法時傳入額外參數
- **播放模式功能**: 實現了單曲循環、隨機播放、循環播放清單、播完後待機四種播放模式
- **命令參數傳遞**: 統一使用關鍵字參數 `title=song_title`，確保參數正確傳遞

## 新增功能 - YouTube Cookies 支援
- **問題**: 某些私人或受限制的 YouTube 影片無法下載
- **解決**：
  1. 從瀏覽器導出 YouTube cookies
  2. 創建 config/cookies_config.py 存儲 cookies 設定
  3. 修改 download_song 函數使用 cookies 進行認證
  4. 通過共享狀態模塊在全局範圍使用 cookies 路徑
- **優點**：
  1. 可以下載私人或受限影片 (如果用戶有權限)
  2. 設置一次後所有下載都會自動使用認證
  3. 不會將認證信息硬編碼到主程序中

## 音頻優化的平衡之道
我們發現，音頻處理需要在功能豐富性和穩定性之間取得平衡：
1. 過度複雜的參數和前處理會導致播放不穩定
2. 但基本的音量控制仍然是必要的，以解決爆音問題
3. 最佳實踐是使用最少的參數達到足夠的效果
4. Discord.py 內建的 PCMVolumeTransformer 已經提供足夠的音量控制功能

## 未來改進方向 (從簡單做起)
1. 確保基本播放穩定後再嘗試音質優化
2. 考慮使用更穩定的播放庫
3. 將複雜功能設為選項，而非默認
4. 重視可靠性勝於功能豐富度